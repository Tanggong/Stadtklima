<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OpenLayers TopoJSON Example</title>
    <!-- Include OpenLayers CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ol@v9.0.0/ol.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/ol@v9.0.0/dist/ol.js"></script>

    <script
    src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"
    integrity="sha512-M7nHCiNUOwFt6Us3r8alutZLm9qMt4s9951uo8jqO4UwJ1hziseL6O3ndFyigx6+LREfZqnhHxYjKRJ8ZQ69DQ=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  ></script>
    <!-- Include OpenLayers JavaScript -->
  </head>
  <body>
    <div id="Mcity-map" style="height: 800px; width: 100%"></div>
    <script>
      // Define your projection here
      var projection = "EPSG:4326"; // You can use the same projection you defined with D3.js

      // Create a new map instance
      var map = new ol.Map({
        target: "Mcity-map",
        layers: [
          osm = new ol.layer.Tile({
            source: new ol.source.OSM(), // Adding OpenStreetMap as the base layer
          }),
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat([13.3777, 52.5182]), // Center the map at (0, 0)
          zoom: 11, // Initial zoom level
          projection: "EPSG:3857",
        }),
      });

      function styleFunction(feature) {
  let colors = d3.scaleThreshold(
  [20, 40, 60, 80],
  ["#F0FADB", "#C6EC79", "#97CD89", "#33A5F5", "#0970B9"]
);

  let stroke = new ol.style.Stroke({ color: 'white', width: 0.1 });
  let value = feature.getProperties().CCA_puf;
  let fill = new ol.style.Fill({ color: colors(value) });
  let style = new ol.style.Style({ stroke: stroke, fill: fill }); 
  return style;
};

      // Load your TopoJSON data
      fetch("geodata/Berlin.json")
        .then((response) => response.json())
        .then((data) => {
          // Convert TopoJSON to GeoJSON
          var geojsonFormat = new ol.format.TopoJSON();
          var features = geojsonFormat.readFeatures(data, {
            dataProjection: "EPSG:4326",
            featureProjection: "EPSG:3857", 
          });
          // Create a vector source and layer
          var ccaSource = new ol.source.Vector({
            features: features,
          });
          var ccaLayer = new ol.layer.Vector({
            source: ccaSource,
            style: styleFunction,
          });
          ccaLayer.setOpacity(0.8);
          osm.setOpacity(0.5);

          // Add the vector layer to the map
          map.addLayer(ccaLayer);
        });
    </script>
  </body>
</html>
